<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔐 Test Login Admin - Portfolio Vincenzo Rocca</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        .header { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); color: white; padding: 30px; border-radius: 20px; text-align: center; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.2); }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        
        .test-card { background: white; border-radius: 20px; padding: 30px; margin-bottom: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
        .test-header { font-size: 1.5rem; font-weight: 600; color: #374151; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #374151; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; transition: all 0.3s; }
        .form-group input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        .btn { padding: 12px 24px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s; margin-right: 12px; margin-bottom: 12px; display: inline-flex; align-items: center; gap: 8px; font-size: 16px; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; transform: translateY(-2px); box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3); }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; transform: translateY(-2px); }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; transform: translateY(-2px); }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; transform: translateY(-2px); }
        
        .status { padding: 16px; border-radius: 12px; margin: 16px 0; font-weight: 500; }
        .status-success { background: #dcfce7; color: #16a34a; border: 1px solid #bbf7d0; }
        .status-error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .status-info { background: #dbeafe; color: #2563eb; border: 1px solid #bfdbfe; }
        .status-warning { background: #fef3c7; color: #d97706; border: 1px solid #fed7aa; }
        
        .console { background: #1f2937; color: #e5e7eb; border-radius: 12px; padding: 20px; font-family: 'Courier New', monospace; font-size: 14px; max-height: 300px; overflow-y: auto; margin-top: 20px; }
        .console-line { margin-bottom: 4px; }
        
        .user-info { background: #f8fafc; border-radius: 12px; padding: 20px; margin: 16px 0; border-left: 4px solid #10b981; }
        .user-info h3 { color: #374151; margin-bottom: 12px; }
        .user-info p { color: #6b7280; margin-bottom: 8px; }
        
        .test-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        
        @media (max-width: 768px) { 
            .test-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔐 Test Login Admin Completo</h1>
            <p>Verifica completa del sistema di autenticazione del portfolio</p>
        </div>

        <!-- Test Login Standard -->
        <div class="test-card">
            <div class="test-header">
                <span>🔓</span>
                <span>Test Login Admin Standard</span>
            </div>
            
            <div id="login-section">
                <div class="form-group">
                    <label>Email Admin:</label>
                    <input type="email" id="login-email" value="vincenzorocca88@gmail.com" placeholder="Email amministratore">
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="login-password" value="admin123" placeholder="Password">
                </div>
                
                <button class="btn btn-primary" onclick="testLogin()">
                    <span>🔓</span> Test Login
                </button>
                <button class="btn btn-warning" onclick="testLoginWrong()">
                    <span>❌</span> Test Login Errato
                </button>
                <button class="btn btn-danger" onclick="logout()">
                    <span>🔒</span> Logout
                </button>
            </div>
            
            <div id="user-info" style="display: none;" class="user-info">
                <h3>✅ Login Effettuato</h3>
                <p><strong>Nome:</strong> <span id="user-name"></span></p>
                <p><strong>Email:</strong> <span id="user-email"></span></p>
                <p><strong>Ruolo:</strong> <span id="user-role"></span></p>
                <p><strong>Ultimo accesso:</strong> <span id="user-last-login"></span></p>
            </div>
        </div>

        <!-- Test Cambio Password -->
        <div class="test-card">
            <div class="test-header">
                <span>🔑</span>
                <span>Test Cambio Password</span>
            </div>
            
            <div class="form-group">
                <label>Password Attuale:</label>
                <input type="password" id="current-password" placeholder="Password corrente">
            </div>
            <div class="form-group">
                <label>Nuova Password:</label>
                <input type="password" id="new-password" placeholder="Nuova password">
            </div>
            <div class="form-group">
                <label>Conferma Nuova Password:</label>
                <input type="password" id="confirm-password" placeholder="Conferma password">
            </div>
            
            <button class="btn btn-warning" onclick="changePassword()">
                <span>🔄</span> Cambia Password
            </button>
            <button class="btn btn-success" onclick="resetPasswordToDefault()">
                <span>🔧</span> Reset a Default (admin123)
            </button>
        </div>

        <!-- Test API Authentication -->
        <div class="test-card">
            <div class="test-header">
                <span>⚡</span>
                <span>Test API Authentication</span>
            </div>
            
            <div class="test-grid">
                <div>
                    <h4>Test Laravel API</h4>
                    <button class="btn btn-primary" onclick="testLaravelAuth()">
                        <span>🔗</span> Test Laravel Login
                    </button>
                    <button class="btn btn-primary" onclick="testLaravelMe()">
                        <span>👤</span> Test Laravel /me
                    </button>
                </div>
                <div>
                    <h4>Test PHP Direct API</h4>
                    <button class="btn btn-success" onclick="testDirectAuth()">
                        <span>⚡</span> Test Direct Login
                    </button>
                    <button class="btn btn-success" onclick="testSessionCheck()">
                        <span>🔍</span> Check Session
                    </button>
                </div>
            </div>
        </div>

        <!-- Test Sicurezza -->
        <div class="test-card">
            <div class="test-header">
                <span>🛡️</span>
                <span>Test Sicurezza</span>
            </div>
            
            <div class="test-grid">
                <div>
                    <h4>Test Protezioni</h4>
                    <button class="btn btn-warning" onclick="testSQLInjection()">
                        <span>⚠️</span> Test SQL Injection
                    </button>
                    <button class="btn btn-warning" onclick="testXSS()">
                        <span>⚠️</span> Test XSS
                    </button>
                </div>
                <div>
                    <h4>Test Accessi</h4>
                    <button class="btn btn-danger" onclick="testUnauthorized()">
                        <span>🚫</span> Test Accesso Negato
                    </button>
                    <button class="btn btn-primary" onclick="testRoleCheck()">
                        <span>👮</span> Test Controllo Ruoli
                    </button>
                </div>
            </div>
        </div>

        <!-- Status e Console -->
        <div id="status-container"></div>
        
        <div class="test-card">
            <div class="test-header">
                <span>🖥️</span>
                <span>Console Debug Login</span>
            </div>
            
            <button class="btn btn-danger" onclick="clearConsole()">
                <span>🗑️</span> Pulisci Console
            </button>
            <button class="btn btn-primary" onclick="runAllLoginTests()">
                <span>🔄</span> Esegui Tutti i Test
            </button>
            
            <div id="console" class="console">
                <div class="console-line">🔐 Test Login System - Console inizializzata</div>
                <div class="console-line">📅 <?= date('Y-m-d H:i:s') ?></div>
                <div class="console-line">🌐 Domain: <?= $_SERVER['HTTP_HOST'] ?></div>
                <div class="console-line">========================</div>
            </div>
        </div>
    </div>

    <script>
        // Stato globale
        let authState = {
            isLoggedIn: false,
            user: null,
            token: null,
            sessionId: null
        };

        // Utility functions
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            
            const line = document.createElement('div');
            line.className = 'console-line';
            line.innerHTML = `${emoji} [${timestamp}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        function showStatus(message, type = 'info') {
            const container = document.getElementById('status-container');
            const status = document.createElement('div');
            status.className = `status status-${type}`;
            status.innerHTML = `<strong>${message}</strong>`;
            container.appendChild(status);
            
            // Rimuovi dopo 5 secondi
            setTimeout(() => {
                if (status.parentNode) {
                    status.parentNode.removeChild(status);
                }
            }, 5000);
        }

        // Test Login Standard
        async function testLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showStatus('❌ Inserisci email e password', 'error');
                return;
            }

            try {
                log(`Tentativo login: ${email}`, 'info');
                
                // Test con API diretta PHP
                const response = await fetch('/api-direct.php?endpoint=login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();
                
                if (result.success && result.user) {
                    authState.isLoggedIn = true;
                    authState.user = result.user;
                    authState.sessionId = result.session_id;
                    
                    // Mostra info utente
                    document.getElementById('user-name').textContent = result.user.name;
                    document.getElementById('user-email').textContent = result.user.email;
                    document.getElementById('user-role').textContent = result.user.is_admin ? 'Amministratore' : 'Utente';
                    document.getElementById('user-last-login').textContent = new Date().toLocaleString();
                    
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('user-info').style.display = 'block';
                    
                    showStatus(`✅ Login effettuato: ${result.user.name}`, 'success');
                    log(`Login SUCCESS: ${result.user.name} (${result.user.email})`, 'success');
                    
                    // Test accesso admin
                    if (result.user.is_admin) {
                        log('User has ADMIN privileges', 'success');
                    } else {
                        log('User has STANDARD privileges', 'warning');
                    }
                    
                } else {
                    throw new Error(result.message || 'Login fallito');
                }
            } catch (error) {
                showStatus(`❌ Errore login: ${error.message}`, 'error');
                log(`Login FAILED: ${error.message}`, 'error');
            }
        }

        // Test Login con credenziali sbagliate
        async function testLoginWrong() {
            log('Testing wrong credentials...', 'warning');
            
            try {
                const response = await fetch('/api-direct.php?endpoint=login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        email: 'wrong@example.com', 
                        password: 'wrongpassword123' 
                    })
                });

                const result = await response.json();
                
                if (!result.success) {
                    showStatus('✅ Test credenziali errate: Respinto correttamente', 'success');
                    log('Wrong credentials correctly REJECTED', 'success');
                } else {
                    showStatus('❌ PROBLEMA: Login riuscito con credenziali errate!', 'error');
                    log('SECURITY ISSUE: Wrong credentials accepted!', 'error');
                }
            } catch (error) {
                showStatus('✅ Sistema sicurezza funziona', 'success');
                log(`Security working: ${error.message}`, 'success');
            }
        }

        // Logout
        async function logout() {
            try {
                log('Executing logout...', 'info');
                
                // Reset stato locale
                authState = {
                    isLoggedIn: false,
                    user: null,
                    token: null,
                    sessionId: null
                };
                
                // Reset UI
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('user-info').style.display = 'none';
                
                // Clear form
                document.getElementById('login-email').value = 'vincenzorocca88@gmail.com';
                document.getElementById('login-password').value = 'admin123';
                
                showStatus('✅ Logout effettuato', 'success');
                log('Logout completed successfully', 'success');
                
            } catch (error) {
                showStatus(`❌ Errore logout: ${error.message}`, 'error');
                log(`Logout error: ${error.message}`, 'error');
            }
        }

        // Cambio Password
        async function changePassword() {
            const current = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirm = document.getElementById('confirm-password').value;

            if (!current || !newPass || !confirm) {
                showStatus('❌ Compila tutti i campi password', 'error');
                return;
            }

            if (newPass !== confirm) {
                showStatus('❌ Le password non coincidono', 'error');
                return;
            }

            if (!authState.isLoggedIn) {
                showStatus('❌ Effettua prima il login', 'error');
                return;
            }

            try {
                log(`Changing password for user: ${authState.user.email}`, 'info');
                
                const response = await fetch('/api-direct.php?endpoint=change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: authState.user.id,
                        current_password: current,
                        new_password: newPass
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showStatus('✅ Password cambiata con successo', 'success');
                    log('Password changed successfully', 'success');
                    
                    // Clear form
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                    
                } else {
                    throw new Error(result.error || 'Errore cambio password');
                }
            } catch (error) {
                showStatus(`❌ Errore cambio password: ${error.message}`, 'error');
                log(`Password change failed: ${error.message}`, 'error');
            }
        }

        // Reset Password a Default
        async function resetPasswordToDefault() {
            if (!confirm('Sei sicuro di voler resettare la password a "admin123"?')) {
                return;
            }

            try {
                log('Resetting password to default...', 'warning');
                
                // Simula reset password (dovrebbe essere implementato lato server)
                showStatus('⚠️ Reset password: Funzionalità da implementare lato server', 'warning');
                log('Password reset functionality needs server implementation', 'warning');
                
            } catch (error) {
                showStatus(`❌ Errore reset password: ${error.message}`, 'error');
                log(`Password reset error: ${error.message}`, 'error');
            }
        }

        // Test Laravel API
        async function testLaravelAuth() {
            try {
                log('Testing Laravel API authentication...', 'info');
                
                const response = await fetch('/api/v1/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'vincenzorocca88@gmail.com',
                        password: 'admin123'
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus('✅ Laravel API: Autenticazione funzionante', 'success');
                    log('Laravel API authentication working', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showStatus('⚠️ Laravel API non accessibile - usando fallback PHP', 'warning');
                log(`Laravel API not accessible: ${error.message}`, 'warning');
            }
        }

        // Test Laravel /me endpoint
        async function testLaravelMe() {
            try {
                log('Testing Laravel /me endpoint...', 'info');
                
                const response = await fetch('/api/v1/auth/me', {
                    method: 'GET',
                    headers: { 
                        'Authorization': `Bearer ${authState.token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus('✅ Laravel /me endpoint funzionante', 'success');
                    log('Laravel /me endpoint working', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showStatus('⚠️ Laravel /me endpoint non accessibile', 'warning');
                log(`Laravel /me endpoint error: ${error.message}`, 'warning');
            }
        }

        // Test Direct API Auth
        async function testDirectAuth() {
            try {
                log('Testing direct PHP API authentication...', 'info');
                
                const response = await fetch('/api-direct.php?endpoint=login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'vincenzorocca88@gmail.com',
                        password: 'admin123'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showStatus('✅ PHP Direct API: Autenticazione funzionante', 'success');
                    log('Direct PHP API authentication working', 'success');
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                showStatus(`❌ PHP Direct API error: ${error.message}`, 'error');
                log(`Direct API authentication error: ${error.message}`, 'error');
            }
        }

        // Test Session Check
        async function testSessionCheck() {
            try {
                log('Checking session status...', 'info');
                
                // Testa se la sessione è attiva
                const response = await fetch('/test-db.php');
                
                if (response.ok) {
                    showStatus('✅ Session check: Server risponde', 'success');
                    log('Session check: Server responding', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showStatus(`❌ Session check error: ${error.message}`, 'error');
                log(`Session check error: ${error.message}`, 'error');
            }
        }

        // Test SQL Injection
        async function testSQLInjection() {
            try {
                log('Testing SQL injection protection...', 'warning');
                
                const maliciousEmail = "admin@test.com'; DROP TABLE users; --";
                const response = await fetch('/api-direct.php?endpoint=login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: maliciousEmail,
                        password: 'test'
                    })
                });

                const result = await response.json();
                
                if (!result.success) {
                    showStatus('✅ SQL Injection: Protezione attiva', 'success');
                    log('SQL injection protection working', 'success');
                } else {
                    showStatus('❌ PROBLEMA: SQL Injection non bloccata!', 'error');
                    log('SECURITY ISSUE: SQL injection not blocked!', 'error');
                }
            } catch (error) {
                showStatus('✅ SQL Injection: Sistema protetto', 'success');
                log('SQL injection blocked by security', 'success');
            }
        }

        // Test XSS
        async function testXSS() {
            try {
                log('Testing XSS protection...', 'warning');
                
                const xssPayload = "<script>alert('XSS')</script>";
                const response = await fetch('/api-direct.php?endpoint=login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: xssPayload,
                        password: 'test'
                    })
                });

                // Se arriviamo qui senza alert, la protezione funziona
                showStatus('✅ XSS Protection: Sistema protetto', 'success');
                log('XSS protection working', 'success');
                
            } catch (error) {
                showStatus('✅ XSS Protection: Attacco bloccato', 'success');
                log('XSS attack blocked', 'success');
            }
        }

        // Test Unauthorized Access
        async function testUnauthorized() {
            try {
                log('Testing unauthorized access...', 'warning');
                
                // Prova ad accedere a un endpoint protetto senza auth
                const response = await fetch('/api/v1/admin/projects', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.status === 401 || response.status === 403) {
                    showStatus('✅ Accesso negato: Protezione attiva', 'success');
                    log('Unauthorized access correctly blocked', 'success');
                } else {
                    showStatus('❌ PROBLEMA: Accesso non autorizzato consentito!', 'error');
                    log('SECURITY ISSUE: Unauthorized access allowed!', 'error');
                }
            } catch (error) {
                showStatus('✅ Protezione accessi: Sistema sicuro', 'success');
                log('Access protection working', 'success');
            }
        }

        // Test Role Check
        async function testRoleCheck() {
            if (!authState.isLoggedIn) {
                showStatus('❌ Effettua prima il login per testare i ruoli', 'error');
                return;
            }

            try {
                log('Testing role-based access control...', 'info');
                
                if (authState.user.is_admin) {
                    showStatus('✅ Controllo ruoli: Utente ha privilegi admin', 'success');
                    log('Role check: User has admin privileges', 'success');
                } else {
                    showStatus('⚠️ Controllo ruoli: Utente NON ha privilegi admin', 'warning');
                    log('Role check: User does NOT have admin privileges', 'warning');
                }
            } catch (error) {
                showStatus(`❌ Errore controllo ruoli: ${error.message}`, 'error');
                log(`Role check error: ${error.message}`, 'error');
            }
        }

        // Esegui tutti i test
        async function runAllLoginTests() {
            log('=== STARTING COMPREHENSIVE LOGIN TEST SUITE ===', 'info');
            showStatus('🔄 Esecuzione test completi login...', 'info');
            
            const tests = [
                () => testDirectAuth(),
                () => testLoginWrong(), 
                () => testLaravelAuth(),
                () => testSessionCheck(),
                () => testSQLInjection(),
                () => testXSS(),
                () => testUnauthorized()
            ];

            let passed = 0;
            let failed = 0;

            for (const test of tests) {
                try {
                    await test();
                    passed++;
                } catch (error) {
                    failed++;
                }
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            log(`=== LOGIN TEST SUITE COMPLETED: ${passed} passed, ${failed} failed ===`, 'info');
            showStatus(`✅ Test login completi: ${passed} successi, ${failed} fallimenti`, 'success');
        }

        // Clear Console
        function clearConsole() {
            const console = document.getElementById('console');
            console.innerHTML = '<div class="console-line">🔐 Console login pulita</div>';
        }

        // Initialize
        window.onload = function() {
            log('Login test system initialized', 'success');
            showStatus('✅ Sistema test login inizializzato', 'success');
        };
    </script>
</body>
</html> 