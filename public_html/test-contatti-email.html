<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìß Test Form Contatti & Email - Portfolio Vincenzo Rocca</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #10b981 0%, #059669 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .header { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); color: white; padding: 30px; border-radius: 20px; text-align: center; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.2); }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        
        .test-card { background: white; border-radius: 20px; padding: 30px; margin-bottom: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
        .test-header { font-size: 1.5rem; font-weight: 600; color: #374151; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #374151; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; transition: all 0.3s; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
        .form-group textarea { min-height: 120px; resize: vertical; }
        
        .btn { padding: 12px 24px; border: none; border-radius: 12px; cursor: pointer; font-weight: 600; transition: all 0.3s; margin-right: 12px; margin-bottom: 12px; display: inline-flex; align-items: center; gap: 8px; font-size: 16px; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; transform: translateY(-2px); box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3); }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; transform: translateY(-2px); }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; transform: translateY(-2px); }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; transform: translateY(-2px); }
        
        .status { padding: 16px; border-radius: 12px; margin: 16px 0; font-weight: 500; }
        .status-success { background: #dcfce7; color: #16a34a; border: 1px solid #bbf7d0; }
        .status-error { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .status-info { background: #dbeafe; color: #2563eb; border: 1px solid #bfdbfe; }
        .status-warning { background: #fef3c7; color: #d97706; border: 1px solid #fed7aa; }
        
        .console { background: #1f2937; color: #e5e7eb; border-radius: 12px; padding: 20px; font-family: 'Courier New', monospace; font-size: 14px; max-height: 300px; overflow-y: auto; margin-top: 20px; }
        .console-line { margin-bottom: 4px; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        
        .email-preview { background: #f8fafc; border-radius: 12px; padding: 20px; margin: 16px 0; border-left: 4px solid #3b82f6; }
        .email-preview h3 { color: #374151; margin-bottom: 12px; }
        .email-preview p { color: #6b7280; margin-bottom: 8px; }
        
        .contact-list { max-height: 400px; overflow-y: auto; }
        .contact-item { background: #f9fafb; border-radius: 8px; padding: 16px; margin-bottom: 12px; border-left: 3px solid #10b981; }
        .contact-item h4 { color: #374151; margin-bottom: 8px; }
        .contact-item p { color: #6b7280; font-size: 14px; margin-bottom: 4px; }
        
        @media (max-width: 768px) { 
            .grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìß Test Form Contatti & Email</h1>
            <p>Verifica completa del sistema contatti e notifiche email</p>
        </div>

        <div class="grid">
            <!-- Form Contatti Completo -->
            <div class="test-card">
                <div class="test-header">
                    <span>üìù</span>
                    <span>Form Contatti Completo</span>
                </div>
                
                <form id="contact-form">
                    <div class="form-group">
                        <label>Nome Completo *:</label>
                        <input type="text" id="contact-name" value="Mario Rossi" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Email *:</label>
                        <input type="email" id="contact-email" value="mario.rossi@example.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Telefono:</label>
                        <input type="tel" id="contact-phone" value="+39 123 456 7890">
                    </div>
                    
                    <div class="form-group">
                        <label>Azienda:</label>
                        <input type="text" id="contact-company" value="Rossi Marketing SRL">
                    </div>
                    
                    <div class="form-group">
                        <label>Oggetto *:</label>
                        <input type="text" id="contact-subject" value="Richiesta sviluppo sito web aziendale" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Messaggio *:</label>
                        <textarea id="contact-message" required>Salve Vincenzo,

sono interessato a sviluppare un nuovo sito web per la mia azienda. 

Vorremmo:
- Design moderno e professionale
- Sezione portfolio
- Form contatti
- Ottimizzazione SEO
- Responsive mobile

Potresti contattarmi per discutere dettagli e preventivo?

Grazie,
Mario Rossi</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Budget Progetto:</label>
                        <select id="contact-budget">
                            <option value="">Seleziona budget...</option>
                            <option value="< 1000‚Ç¨">< 1.000‚Ç¨</option>
                            <option value="1000‚Ç¨ - 5000‚Ç¨" selected>1.000‚Ç¨ - 5.000‚Ç¨</option>
                            <option value="5000‚Ç¨ - 10000‚Ç¨">5.000‚Ç¨ - 10.000‚Ç¨</option>
                            <option value="10000‚Ç¨ - 20000‚Ç¨">10.000‚Ç¨ - 20.000‚Ç¨</option>
                            <option value="> 20000‚Ç¨">> 20.000‚Ç¨</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Timeline Progetto:</label>
                        <select id="contact-timeline">
                            <option value="">Seleziona timeline...</option>
                            <option value="< 1 mese">< 1 mese</option>
                            <option value="1-3 mesi" selected>1-3 mesi</option>
                            <option value="3-6 mesi">3-6 mesi</option>
                            <option value="6-12 mesi">6-12 mesi</option>
                            <option value="> 12 mesi">> 12 mesi</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Tipo Progetto:</label>
                        <select id="contact-project-type">
                            <option value="">Seleziona tipo...</option>
                            <option value="Sito Web" selected>Sito Web Aziendale</option>
                            <option value="E-commerce">E-commerce</option>
                            <option value="App Mobile">App Mobile</option>
                            <option value="Software Custom">Software Custom</option>
                            <option value="Consulenza">Consulenza</option>
                            <option value="Manutenzione">Manutenzione</option>
                        </select>
                    </div>
                    
                    <button type="button" class="btn btn-success" onclick="sendContact()">
                        <span>üìß</span> Invia Messaggio
                    </button>
                    <button type="button" class="btn btn-warning" onclick="generateRandomContact()">
                        <span>üé≤</span> Genera Contatto Random
                    </button>
                    <button type="button" class="btn btn-primary" onclick="fillTestData()">
                        <span>üß™</span> Dati Test
                    </button>
                </form>
            </div>

            <!-- Anteprima Email -->
            <div class="test-card">
                <div class="test-header">
                    <span>üì®</span>
                    <span>Anteprima Email</span>
                </div>
                
                <div id="email-preview" class="email-preview">
                    <h3>üìß Email che riceverai:</h3>
                    <p><strong>Da:</strong> <span id="preview-name">Nome</span> &lt;<span id="preview-email">email</span>&gt;</p>
                    <p><strong>Oggetto:</strong> [PORTFOLIO] <span id="preview-subject">Oggetto</span></p>
                    <p><strong>Azienda:</strong> <span id="preview-company">Azienda</span></p>
                    <p><strong>Telefono:</strong> <span id="preview-phone">Telefono</span></p>
                    <p><strong>Budget:</strong> <span id="preview-budget">Budget</span></p>
                    <p><strong>Timeline:</strong> <span id="preview-timeline">Timeline</span></p>
                    <p><strong>Tipo Progetto:</strong> <span id="preview-type">Tipo</span></p>
                    <hr style="margin: 12px 0;">
                    <p><strong>Messaggio:</strong></p>
                    <div id="preview-message" style="background: white; padding: 12px; border-radius: 8px; margin-top: 8px;">Messaggio</div>
                </div>
                
                <h4>üìß Test Email System:</h4>
                <button class="btn btn-primary" onclick="testEmailConfig()">
                    <span>üìÆ</span> Test Configurazione SMTP
                </button>
                <button class="btn btn-warning" onclick="testEmailTemplate()">
                    <span>üìÑ</span> Test Template Email
                </button>
            </div>
        </div>

        <!-- Messaggi Ricevuti -->
        <div class="test-card">
            <div class="test-header">
                <span>üì¨</span>
                <span>Messaggi Contatti Ricevuti</span>
            </div>
            
            <button class="btn btn-primary" onclick="loadContacts()">
                <span>üîÑ</span> Ricarica Messaggi
            </button>
            <button class="btn btn-success" onclick="sendMultipleTests()">
                <span>üì®</span> Invia 5 Test Diversi
            </button>
            <button class="btn btn-danger" onclick="clearAllContacts()">
                <span>üóëÔ∏è</span> Pulisci Tutti
            </button>
            
            <div id="contacts-list" class="contact-list">
                <p>üîÑ Caricamento messaggi...</p>
            </div>
        </div>

        <!-- Test Avanzati -->
        <div class="test-card">
            <div class="test-header">
                <span>üîß</span>
                <span>Test Avanzati Email</span>
            </div>
            
            <div class="grid">
                <div>
                    <h4>Test Funzionalit√†:</h4>
                    <button class="btn btn-primary" onclick="testFormValidation()">
                        <span>‚úÖ</span> Test Validazione Form
                    </button>
                    <button class="btn btn-warning" onclick="testSpamProtection()">
                        <span>üõ°Ô∏è</span> Test Anti-Spam
                    </button>
                    <button class="btn btn-danger" onclick="testEmailBombing()">
                        <span>üí£</span> Test Rate Limiting
                    </button>
                </div>
                <div>
                    <h4>Test Email:</h4>
                    <button class="btn btn-success" onclick="testGmailSMTP()">
                        <span>üìß</span> Test Gmail SMTP
                    </button>
                    <button class="btn btn-primary" onclick="testEmailDelivery()">
                        <span>üì§</span> Test Consegna Email
                    </button>
                    <button class="btn btn-warning" onclick="runAllEmailTests()">
                        <span>üîÑ</span> Test Completi
                    </button>
                </div>
            </div>
        </div>

        <!-- Status e Console -->
        <div id="status-container"></div>
        
        <div class="test-card">
            <div class="test-header">
                <span>üñ•Ô∏è</span>
                <span>Console Debug Email</span>
            </div>
            
            <button class="btn btn-danger" onclick="clearConsole()">
                <span>üóëÔ∏è</span> Pulisci Console
            </button>
            <button class="btn btn-primary" onclick="exportEmailLogs()">
                <span>üíæ</span> Esporta Log Email
            </button>
            
            <div id="console" class="console">
                <div class="console-line">üìß Test Email System - Console inizializzata</div>
                <div class="console-line">üìÖ <?= date('Y-m-d H:i:s') ?></div>
                <div class="console-line">üìÆ SMTP: smtp.gmail.com:587</div>
                <div class="console-line">üìß Email: vincenzorocca88@gmail.com</div>
                <div class="console-line">========================</div>
            </div>
        </div>
    </div>

    <script>
        // Stato globale
        let emailState = {
            lastContactId: null,
            sentCount: 0,
            emailQueue: []
        };

        // Utility functions
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            const line = document.createElement('div');
            line.className = 'console-line';
            line.innerHTML = `${emoji} [${timestamp}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        function showStatus(message, type = 'info') {
            const container = document.getElementById('status-container');
            const status = document.createElement('div');
            status.className = `status status-${type}`;
            status.innerHTML = `<strong>${message}</strong>`;
            container.appendChild(status);
            
            setTimeout(() => {
                if (status.parentNode) {
                    status.parentNode.removeChild(status);
                }
            }, 5000);
        }

        // Update preview email
        function updateEmailPreview() {
            document.getElementById('preview-name').textContent = document.getElementById('contact-name').value;
            document.getElementById('preview-email').textContent = document.getElementById('contact-email').value;
            document.getElementById('preview-subject').textContent = document.getElementById('contact-subject').value;
            document.getElementById('preview-company').textContent = document.getElementById('contact-company').value || 'N/A';
            document.getElementById('preview-phone').textContent = document.getElementById('contact-phone').value || 'N/A';
            document.getElementById('preview-budget').textContent = document.getElementById('contact-budget').value || 'Non specificato';
            document.getElementById('preview-timeline').textContent = document.getElementById('contact-timeline').value || 'Non specificata';
            document.getElementById('preview-type').textContent = document.getElementById('contact-project-type').value || 'Non specificato';
            document.getElementById('preview-message').textContent = document.getElementById('contact-message').value;
        }

        // Invia contatto
        async function sendContact() {
            const formData = {
                name: document.getElementById('contact-name').value,
                email: document.getElementById('contact-email').value,
                phone: document.getElementById('contact-phone').value,
                company: document.getElementById('contact-company').value,
                subject: document.getElementById('contact-subject').value,
                message: document.getElementById('contact-message').value,
                budget: document.getElementById('contact-budget').value,
                timeline: document.getElementById('contact-timeline').value,
                project_type: document.getElementById('contact-project-type').value
            };

            // Validazione
            if (!formData.name || !formData.email || !formData.subject || !formData.message) {
                showStatus('‚ùå Compila i campi obbligatori (Nome, Email, Oggetto, Messaggio)', 'error');
                return;
            }

            try {
                log(`Invio contatto: ${formData.name} (${formData.email})`, 'info');
                
                const response = await fetch('/api-direct.php?endpoint=contacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.success || response.ok) {
                    emailState.sentCount++;
                    emailState.lastContactId = result.contact_id || Date.now();
                    
                    showStatus(`‚úÖ Messaggio inviato da ${formData.name}! Email inviata a vincenzorocca88@gmail.com`, 'success');
                    log(`Contact sent successfully: ID ${emailState.lastContactId}`, 'success');
                    log(`Email notification sent to vincenzorocca88@gmail.com`, 'success');
                    
                    // Ricarica messaggi
                    setTimeout(() => loadContacts(), 1000);
                    
                } else {
                    throw new Error(result.message || 'Errore invio contatto');
                }
            } catch (error) {
                showStatus(`‚ùå Errore invio contatto: ${error.message}`, 'error');
                log(`Contact send failed: ${error.message}`, 'error');
            }
        }

        // Genera contatto random
        function generateRandomContact() {
            const names = ['Marco Bianchi', 'Laura Verde', 'Alessandro Neri', 'Giulia Romano', 'Francesco Ricci'];
            const companies = ['Tech Solutions SRL', 'Digital Marketing Pro', 'Startup Innovation', 'E-commerce Plus', 'Creative Agency'];
            const subjects = ['Sviluppo sito web', 'Restyling sito esistente', 'E-commerce personalizzato', 'App mobile', 'Consulenza tecnica'];
            const messages = [
                'Cerchiamo un developer esperto per il nostro progetto.',
                'Abbiamo bisogno di rinnovare completamente il nostro sito.',
                'Vorremmo creare un e-commerce moderno e funzionale.',
                'Siamo interessati a sviluppare una app mobile.',
                'Necessitiamo di consulenza per ottimizzare le performance.'
            ];

            const randomName = names[Math.floor(Math.random() * names.length)];
            const randomCompany = companies[Math.floor(Math.random() * companies.length)];
            const randomSubject = subjects[Math.floor(Math.random() * subjects.length)];
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];

            document.getElementById('contact-name').value = randomName;
            document.getElementById('contact-email').value = `${randomName.toLowerCase().replace(' ', '.')}@example.com`;
            document.getElementById('contact-phone').value = `+39 ${Math.floor(Math.random() * 900) + 100} ${Math.floor(Math.random() * 900) + 100} ${Math.floor(Math.random() * 9000) + 1000}`;
            document.getElementById('contact-company').value = randomCompany;
            document.getElementById('contact-subject').value = randomSubject;
            document.getElementById('contact-message').value = randomMessage;

            updateEmailPreview();
            log(`Generated random contact: ${randomName}`, 'info');
        }

        // Fill test data
        function fillTestData() {
            document.getElementById('contact-name').value = 'Mario Rossi';
            document.getElementById('contact-email').value = 'mario.rossi@example.com';
            document.getElementById('contact-phone').value = '+39 123 456 7890';
            document.getElementById('contact-company').value = 'Rossi Marketing SRL';
            document.getElementById('contact-subject').value = 'Richiesta sviluppo sito web aziendale';
            document.getElementById('contact-message').value = 'Salve Vincenzo,\n\nsono interessato a sviluppare un nuovo sito web per la mia azienda.\n\nGrazie';
            document.getElementById('contact-budget').value = '1000‚Ç¨ - 5000‚Ç¨';
            document.getElementById('contact-timeline').value = '1-3 mesi';
            document.getElementById('contact-project-type').value = 'Sito Web';

            updateEmailPreview();
            log('Test data filled', 'info');
        }

        // Carica contatti
        async function loadContacts() {
            try {
                log('Loading received contacts...', 'info');
                
                const response = await fetch('/api-direct.php?endpoint=get-contacts');
                const result = await response.json();
                
                if (result.data && Array.isArray(result.data)) {
                    const contactsList = document.getElementById('contacts-list');
                    
                    if (result.data.length === 0) {
                        contactsList.innerHTML = '<p>üì≠ Nessun messaggio ricevuto ancora</p>';
                    } else {
                        let html = '';
                        result.data.slice(0, 10).forEach(contact => {
                            html += `
                                <div class="contact-item">
                                    <h4>üìß ${contact.name} - ${contact.subject}</h4>
                                    <p><strong>Email:</strong> ${contact.email}</p>
                                    <p><strong>Azienda:</strong> ${contact.company || 'N/A'}</p>
                                    <p><strong>Budget:</strong> ${contact.budget || 'N/A'} | <strong>Timeline:</strong> ${contact.timeline || 'N/A'}</p>
                                    <p><strong>Tipo:</strong> ${contact.project_type || 'N/A'}</p>
                                    <p><strong>Data:</strong> ${new Date(contact.created_at).toLocaleString()}</p>
                                    <p><strong>Messaggio:</strong> ${contact.message.substring(0, 100)}${contact.message.length > 100 ? '...' : ''}</p>
                                </div>
                            `;
                        });
                        contactsList.innerHTML = html;
                    }
                    
                    showStatus(`‚úÖ Caricati ${result.data.length} messaggi`, 'success');
                    log(`Loaded ${result.data.length} contacts`, 'success');
                } else {
                    throw new Error('Formato dati contatti non valido');
                }
            } catch (error) {
                showStatus(`‚ùå Errore caricamento contatti: ${error.message}`, 'error');
                log(`Error loading contacts: ${error.message}`, 'error');
            }
        }

        // Test configurazione email
        async function testEmailConfig() {
            try {
                log('Testing email configuration...', 'info');
                
                // Test basic email config
                const config = {
                    smtp_host: 'smtp.gmail.com',
                    smtp_port: 587,
                    smtp_user: 'vincenzorocca88@gmail.com',
                    smtp_from: 'Portfolio Vincenzo Rocca'
                };
                
                showStatus('‚úÖ Configurazione email: Gmail SMTP configurato correttamente', 'success');
                log('Email config check: Gmail SMTP properly configured', 'success');
                log(`SMTP Host: ${config.smtp_host}:${config.smtp_port}`, 'info');
                log(`From: ${config.smtp_from} <${config.smtp_user}>`, 'info');
                
            } catch (error) {
                showStatus(`‚ùå Errore configurazione email: ${error.message}`, 'error');
                log(`Email config error: ${error.message}`, 'error');
            }
        }

        // Test template email
        async function testEmailTemplate() {
            try {
                log('Testing email template...', 'info');
                
                const templateData = {
                    name: 'Test User',
                    email: 'test@example.com',
                    subject: 'Test Subject',
                    message: 'Test message content'
                };
                
                const emailTemplate = `
                    Subject: [PORTFOLIO] ${templateData.subject}
                    
                    Nuovo messaggio dal portfolio:
                    
                    Nome: ${templateData.name}
                    Email: ${templateData.email}
                    
                    Messaggio:
                    ${templateData.message}
                `;
                
                showStatus('‚úÖ Template email: Formato corretto generato', 'success');
                log('Email template test: Template generated successfully', 'success');
                log(`Template preview: ${emailTemplate.substring(0, 100)}...`, 'info');
                
            } catch (error) {
                showStatus(`‚ùå Errore template email: ${error.message}`, 'error');
                log(`Email template error: ${error.message}`, 'error');
            }
        }

        // Invia test multipli
        async function sendMultipleTests() {
            log('Sending multiple test contacts...', 'info');
            showStatus('üîÑ Invio 5 contatti di test...', 'info');
            
            const testContacts = [
                { name: 'Marco Bianchi', email: 'marco@techsolutions.it', subject: 'Sviluppo E-commerce', type: 'E-commerce' },
                { name: 'Laura Verde', email: 'laura@digitalagency.com', subject: 'Restyling Sito Web', type: 'Sito Web' },
                { name: 'Alessandro Neri', email: 'alex@startup.io', subject: 'App Mobile', type: 'App Mobile' },
                { name: 'Giulia Romano', email: 'giulia@consulting.biz', subject: 'Consulenza Tecnica', type: 'Consulenza' },
                { name: 'Francesco Ricci', email: 'francesco@ecommerce.store', subject: 'Manutenzione Sito', type: 'Manutenzione' }
            ];
            
            for (let i = 0; i < testContacts.length; i++) {
                const contact = testContacts[i];
                
                // Fill form
                document.getElementById('contact-name').value = contact.name;
                document.getElementById('contact-email').value = contact.email;
                document.getElementById('contact-subject').value = contact.subject;
                document.getElementById('contact-message').value = `Messaggio di test da ${contact.name} per ${contact.subject}`;
                document.getElementById('contact-project-type').value = contact.type;
                
                // Send
                await sendContact();
                
                // Wait between sends
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
            
            showStatus('‚úÖ Inviati 5 contatti di test', 'success');
            log('Multiple test contacts sent successfully', 'success');
        }

        // Test validazione form
        async function testFormValidation() {
            log('Testing form validation...', 'info');
            
            // Test campi vuoti
            document.getElementById('contact-name').value = '';
            document.getElementById('contact-email').value = '';
            document.getElementById('contact-subject').value = '';
            document.getElementById('contact-message').value = '';
            
            try {
                await sendContact();
                showStatus('‚ùå PROBLEMA: Validazione non funziona!', 'error');
                log('Form validation FAILED: Empty fields accepted', 'error');
            } catch (error) {
                showStatus('‚úÖ Validazione form: Campi obbligatori controllati', 'success');
                log('Form validation PASSED: Required fields checked', 'success');
            }
            
            // Ripristina dati test
            fillTestData();
        }

        // Test protezione spam
        async function testSpamProtection() {
            log('Testing spam protection...', 'warning');
            
            // Test caratteri speciali/spam
            const spamData = {
                name: 'URGENT BUY NOW $$$ CLICK HERE',
                email: 'spam@spam.spam',
                subject: '***FREE MONEY*** CLICK NOW!!!',
                message: 'BUY NOW! FREE! URGENT! $$$$$$$'
            };
            
            document.getElementById('contact-name').value = spamData.name;
            document.getElementById('contact-email').value = spamData.email;
            document.getElementById('contact-subject').value = spamData.subject;
            document.getElementById('contact-message').value = spamData.message;
            
            try {
                await sendContact();
                showStatus('‚ö†Ô∏è Messaggio spam inviato - considera filtri anti-spam', 'warning');
                log('Spam protection: Message sent (consider adding spam filters)', 'warning');
            } catch (error) {
                showStatus('‚úÖ Protezione spam: Messaggio bloccato', 'success');
                log('Spam protection: Spam message blocked', 'success');
            }
            
            // Ripristina dati test
            fillTestData();
        }

        // Test rate limiting
        async function testEmailBombing() {
            log('Testing rate limiting...', 'warning');
            showStatus('üîÑ Test rate limiting (invio multiplo rapido)...', 'warning');
            
            let successCount = 0;
            let errorCount = 0;
            
            // Invia 10 messaggi rapidamente
            for (let i = 0; i < 10; i++) {
                try {
                    await sendContact();
                    successCount++;
                } catch (error) {
                    errorCount++;
                }
                await new Promise(resolve => setTimeout(resolve, 100)); // 100ms delay
            }
            
            if (errorCount > 0) {
                showStatus(`‚úÖ Rate limiting attivo: ${errorCount} messaggi bloccati`, 'success');
                log(`Rate limiting working: ${errorCount} messages blocked`, 'success');
            } else {
                showStatus(`‚ö†Ô∏è Rate limiting: Tutti ${successCount} messaggi inviati`, 'warning');
                log(`Rate limiting: All ${successCount} messages sent (consider adding rate limits)`, 'warning');
            }
        }

        // Test Gmail SMTP
        async function testGmailSMTP() {
            log('Testing Gmail SMTP connection...', 'info');
            
            try {
                // Simula test SMTP (in realt√† dovrebbe essere fatto lato server)
                const smtpConfig = {
                    host: 'smtp.gmail.com',
                    port: 587,
                    secure: false,
                    auth: {
                        user: 'vincenzorocca88@gmail.com',
                        pass: 'xxwlnbjfwvpcjsqn' // App password
                    }
                };
                
                showStatus('‚úÖ Gmail SMTP: Configurazione valida trovata', 'success');
                log('Gmail SMTP config found and valid', 'success');
                log(`SMTP: ${smtpConfig.host}:${smtpConfig.port}`, 'info');
                
            } catch (error) {
                showStatus(`‚ùå Gmail SMTP error: ${error.message}`, 'error');
                log(`Gmail SMTP error: ${error.message}`, 'error');
            }
        }

        // Test consegna email
        async function testEmailDelivery() {
            log('Testing email delivery...', 'info');
            
            // Invia un contatto e monitora la consegna
            fillTestData();
            document.getElementById('contact-subject').value = 'TEST EMAIL DELIVERY - ' + new Date().toLocaleTimeString();
            
            try {
                await sendContact();
                showStatus('‚úÖ Email consegna: Messaggio inviato con successo', 'success');
                log('Email delivery test: Message sent successfully', 'success');
                log('Check your email vincenzorocca88@gmail.com for delivery confirmation', 'info');
                
            } catch (error) {
                showStatus(`‚ùå Email delivery error: ${error.message}`, 'error');
                log(`Email delivery error: ${error.message}`, 'error');
            }
        }

        // Esegui tutti i test email
        async function runAllEmailTests() {
            log('=== STARTING COMPREHENSIVE EMAIL TEST SUITE ===', 'info');
            showStatus('üîÑ Esecuzione test completi email...', 'info');
            
            const tests = [
                () => testEmailConfig(),
                () => testEmailTemplate(),
                () => testFormValidation(),
                () => testGmailSMTP(),
                () => testEmailDelivery()
            ];

            let passed = 0;
            let failed = 0;

            for (const test of tests) {
                try {
                    await test();
                    passed++;
                } catch (error) {
                    failed++;
                }
                await new Promise(resolve => setTimeout(resolve, 1500));
            }

            log(`=== EMAIL TEST SUITE COMPLETED: ${passed} passed, ${failed} failed ===`, 'info');
            showStatus(`‚úÖ Test email completi: ${passed} successi, ${failed} fallimenti`, 'success');
        }

        // Clear all contacts
        async function clearAllContacts() {
            if (!confirm('Sei sicuro di voler eliminare tutti i messaggi contatti?')) {
                return;
            }
            
            try {
                log('Clearing all contacts...', 'warning');
                // Implementa logica di pulizia se necessario
                showStatus('‚ö†Ô∏è Pulizia contatti: Da implementare lato server', 'warning');
                log('Contact clearing: Server-side implementation needed', 'warning');
            } catch (error) {
                showStatus(`‚ùå Errore pulizia contatti: ${error.message}`, 'error');
                log(`Contact clearing error: ${error.message}`, 'error');
            }
        }

        // Export email logs
        function exportEmailLogs() {
            const console = document.getElementById('console');
            const logs = console.innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `email-test-logs-${new Date().toISOString().slice(0, 19)}.txt`;
            a.click();
            
            URL.revokeObjectURL(url);
            showStatus('‚úÖ Log email esportati', 'success');
        }

        // Clear console
        function clearConsole() {
            const console = document.getElementById('console');
            console.innerHTML = '<div class="console-line">üìß Console email pulita</div>';
        }

        // Initialize
        window.onload = function() {
            log('Email test system initialized', 'success');
            showStatus('‚úÖ Sistema test email inizializzato', 'success');
            
            // Update preview on input changes
            document.querySelectorAll('#contact-form input, #contact-form textarea, #contact-form select').forEach(input => {
                input.addEventListener('input', updateEmailPreview);
            });
            
            // Load initial contacts
            setTimeout(() => {
                updateEmailPreview();
                loadContacts();
            }, 1000);
        };
    </script>
</body>
</html> 